<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>世界の公式集 — 外部JSON版</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa6bf; --accent:#60a5fa; --accent-2:#7c3aed;
  --glass: rgba(255,255,255,0.03);
  font-family: Inter, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color-scheme: dark;
}
*{box-sizing:border-box}
body{
  margin:0; background:linear-gradient(180deg,#081226 0%, #071021 100%); color: #e6eef8;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; padding:24px;
}
.container{max-width:1100px;margin:0 auto;}
.header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
.title{display:flex;gap:14px;align-items:center}
.logo{
  width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;color:white;
  box-shadow:0 6px 20px rgba(12,18,32,0.6);
}
h1{margin:0;font-size:20px}
.subtitle{color:var(--muted);font-size:13px}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.search{
  background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:10px;display:flex;gap:8px;align-items:center;
  min-width:280px;max-width:640px;
}
.search input{background:transparent;border:0;outline:0;color:inherit;font-size:15px;width:360px}
.select, .count{background:var(--glass);padding:8px 10px;border-radius:10px;font-size:13px;color:var(--muted)}
.tags{margin:12px 0;display:flex;gap:8px;flex-wrap:wrap}
.tag{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);font-size:13px}
.tag:hover{background:linear-gradient(90deg,rgba(96,165,250,0.08),rgba(124,58,237,0.06));color:#dbeafe;border-color:rgba(96,165,250,0.25)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.card h3{margin:0;font-size:15px}
.meta{display:flex;gap:8px;align-items:center;margin-top:6px;color:var(--muted);font-size:13px}
.formula{margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.015);font-family: "Times New Roman", serif;font-size:15px;line-height:1.5;white-space:pre-wrap}
.latex{margin-top:8px;color:var(--muted);font-size:13px;word-break:break-all}
.actions{display:flex;gap:8px;margin-top:10px}
.btn{
  padding:6px 9px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);
  cursor:pointer;color:var(--muted);font-size:13px
}
.btn:hover{background:linear-gradient(90deg,rgba(96,165,250,0.06),rgba(124,58,237,0.04));color:#eaf2ff}
.highlight{background:linear-gradient(90deg, rgba(96,165,250,0.12), rgba(124,58,237,0.06));padding:2px 4px;border-radius:4px}
.footer{margin-top:22px;color:var(--muted);font-size:13px}
.count-badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:13px}
.empty{padding:20px;border-radius:10px;background:rgba(255,255,255,0.01);color:var(--muted);text-align:center}
.small{font-size:12px;color:var(--muted)}
.copy-indicator{margin-left:8px;color:#84cc16;font-size:13px;display:none}
@media (max-width:640px){ .search input{width:140px} .header{flex-direction:column;align-items:flex-start;gap:10px} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <div class="logo">公式</div>
      <div>
        <h1>世界の公式集</h1>
        <div class="subtitle">外部 JSON(formulas.json) からロードします。検索／タグ／カテゴリ／LaTeX コピー対応。</div>
      </div>
    </div>

    <div class="controls">
      <div class="search" title="検索語をスペースで区切ると AND 検索になります">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.7"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="11" cy="11" r="6.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></circle></svg>
        <input id="search" placeholder="検索 — 例: '微分 面積 円 周'">
      </div>
      <div class="select" title="カテゴリで絞り込み">
        <label for="category" class="small">カテゴリ</label>
        <select id="category" style="background:transparent;border:0;outline:0;color:inherit;font-size:13px">
          <option value="">すべて</option>
          <option value="数学">数学</option>
          <option value="物理">物理</option>
          <option value="化学">化学</option>
          <option value="工学">工学</option>
          <option value="定数">定数</option>
          <option value="統計">統計</option>
          <option value="信号処理">信号処理</option>
        </select>
      </div>
      <div class="count" id="resultCount">全 <span id="total">0</span> 件</div>
      <button class="btn" id="reloadBtn" title="formulas.json を再読み込み">データ再読み込み</button>
    </div>
  </div>

  <div class="tags" id="tagList" aria-hidden="false">
    <!-- tags inserted by JS -->
  </div>

  <div id="cards" class="grid">
    <!-- cards inserted by JS -->
  </div>

  <div id="empty" class="empty" style="display:none">該当する公式が見つかりませんでした。</div>

  <div class="footer">
    データは formulas.json に保存されています。大量追加する場合は JSON を編集・差し替えてください。MathJax 等のレンダリングは別途追加できます。
  </div>
</div>

<script>
/* 外部 JSON から読み込むようにした index。formulas.json を同じディレクトリに置いてください。
   フェッチに失敗した場合はフォールバックの埋め込みデータ（小規模）を使います。 */

let entries = []; // 実データ

const cardsEl = document.getElementById('cards');
const tagListEl = document.getElementById('tagList');
const searchInput = document.getElementById('search');
const categorySelect = document.getElementById('category');
const resultCount = document.getElementById('total');
const emptyEl = document.getElementById('empty');
const reloadBtn = document.getElementById('reloadBtn');

async function loadData(){
  try{
    const resp = await fetch('formulas.json', {cache: "no-store"});
    if(!resp.ok) throw new Error('Network response not ok');
    const data = await resp.json();
    entries = data;
    initFromEntries();
  }catch(err){
    console.warn('外部 JSON の読み込みに失敗しました:', err);
    // フォールバックとして最小限の埋め込みデータを使う（外部 JSON がない場合も動く）
    entries = [
      {id:1,title:"二次方程式の解の公式",category:"数学",tags:["代数","方程式"],formulaText:"ax^2 + bx + c = 0 の解: x = (-b ± √(b^2 - 4ac)) / (2a)",latex:"x = \\\\frac{-b \\\\pm \\\\sqrt{b^2 - 4ac}}{2a}",description:"a ≠ 0 のときの二次方程式の一般解。"},
      {id:2,title:"等差数列の和",category:"数学",tags:["数列","和"],formulaText:"和 S_n = n(a_1 + a_n)/2",latex:"S_n = \\\\frac{n(a_1 + a_n)}{2}",description:"等差数列の和。"},
      {id:22,title:"ニュートンの運動の第2法則",category:"物理",tags:["力学"],formulaText:"F = m a",latex:"\\\\mathbf{F} = m \\\\mathbf{a}",description:"質量 m に加わる力 F と加速度 a の関係。"}
    ];
    initFromEntries();
  }
}

function initFromEntries(){
  // タグ集合を作って UI を構築
  const tagSet = new Set();
  entries.forEach(e=> (e.tags||[]).forEach(t=>tagSet.add(t)));
  window._tags = Array.from(tagSet).sort();
  createTagElements();
  render(entries);
}

function createTagElements(){
  const tags = window._tags || [];
  const frag = document.createDocumentFragment();
  const allTag = document.createElement('div');
  allTag.className='tag';
  allTag.textContent='すべてのタグ';
  allTag.onclick = ()=>{ applyTag(''); };
  frag.appendChild(allTag);
  tags.forEach(t=>{
    const el=document.createElement('div');
    el.className='tag'; el.textContent=t;
    el.onclick = ()=>{ applyTag(t); };
    frag.appendChild(el);
  });
  tagListEl.innerHTML=''; tagListEl.appendChild(frag);
}

function render(entriesToRender){
  cardsEl.innerHTML='';
  if(entriesToRender.length===0){ emptyEl.style.display='block'; }
  else { emptyEl.style.display='none'; }
  const frag = document.createDocumentFragment();
  entriesToRender.forEach(e=>{
    const card = document.createElement('div'); card.className='card';
    const h = document.createElement('h3'); h.innerHTML = escapeHtml(e.title);
    const meta = document.createElement('div'); meta.className='meta';
    const cat = `<div class="small">${escapeHtml(e.category)}</div>`;
    const tagsHtml = `<div class="small">・タグ: ${ (e.tags||[]).map(t=>`<span class="small" style="color:var(--muted)">${escapeHtml(t)}</span>`).join(', ') }</div>`;
    meta.innerHTML = cat + tagsHtml;
    const f = document.createElement('div'); f.className='formula'; f.textContent = e.formulaText || '';
    const latex = document.createElement('div'); latex.className='latex'; latex.textContent = 'LaTeX: ' + (e.latex || '');
    const desc = document.createElement('div'); desc.className='small'; desc.style.marginTop='8px'; desc.style.color='var(--muted)'; desc.textContent = e.description || '';
    const actions = document.createElement('div'); actions.className='actions';
    const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='LaTeX をコピー';
    copyBtn.onclick = ()=>{ if(navigator.clipboard && e.latex){ navigator.clipboard.writeText(e.latex).then(()=>{ showCopyIndicator(copyBtn); }).catch(()=>{ alert('クリップボードにコピーできませんでした'); }); } else { alert('LaTeX がありません'); } };
    const useTagBtn = document.createElement('button'); useTagBtn.className='btn'; useTagBtn.textContent='タグで絞る';
    useTagBtn.onclick = ()=>{ if(e.tags && e.tags.length>0) applyTag(e.tags[0]); else applyTag(''); };
    actions.appendChild(copyBtn); actions.appendChild(useTagBtn);

    card.appendChild(h); card.appendChild(meta); card.appendChild(f); card.appendChild(latex); card.appendChild(desc); card.appendChild(actions);
    frag.appendChild(card);
  });
  cardsEl.appendChild(frag);
  resultCount.textContent = entriesToRender.length;
}

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

let activeTag = '';
function applyTag(tag){
  activeTag = tag;
  Array.from(tagListEl.children).forEach(el=>{
    el.style.borderColor = 'rgba(255,255,255,0.02)';
    el.style.color = 'var(--muted)';
  });
  const clicked = Array.from(tagListEl.children).find(c=>c.textContent===tag || (tag==='' && c.textContent==='すべてのタグ'));
  if(clicked){ clicked.style.borderColor='rgba(96,165,250,0.35)'; clicked.style.color='#eaf2ff'; }
  applyFilters();
}

function scoredMatch(item, tokens){
  const hay = (item.title + ' ' + (item.formulaText||'') + ' ' + (item.latex||'') + ' ' + (item.description||'') + ' ' + ((item.tags||[]).join(' '))).toLowerCase();
  for(const tok of tokens){
    if(!hay.includes(tok)) return false;
  }
  return true;
}

function applyFilters(){
  const q = (searchInput.value || '').trim().toLowerCase();
  const tokens = q===''?[]:q.split(/\s+/).filter(Boolean);
  const cat = categorySelect.value;
  const filtered = entries.filter(e=>{
    if(cat && e.category !== cat) return false;
    if(activeTag && !(e.tags||[]).includes(activeTag)) return false;
    if(tokens.length===0) return true;
    return scoredMatch(e, tokens);
  });
  render(filtered);
  if(tokens.length>0){
    highlightTokens(tokens);
  }
}

function highlightTokens(tokens){
  Array.from(cardsEl.children).forEach(card=>{
    const titleEl = card.querySelector('h3');
    const formulaEl = card.querySelector('.formula');
    const latexEl = card.querySelector('.latex');
    let title = titleEl.textContent;
    let formula = formulaEl.textContent;
    let latex = latexEl.textContent;
    tokens.forEach(tok=>{
      const re = new RegExp(escapeRegExp(tok), 'ig');
      title = title.replace(re, m=>`@@@HL@@@${m}@@@END@@@`);
      formula = formula.replace(re, m=>`@@@HL@@@${m}@@@END@@@`);
      latex = latex.replace(re, m=>`@@@HL@@@${m}@@@END@@@`);
    });
    titleEl.innerHTML = title.replace(/@@@HL@@@/g, '<span class="highlight">').replace(/@@@END@@@/g, '</span>');
    formulaEl.innerHTML = formula.replace(/@@@HL@@@/g, '<span class="highlight">').replace(/@@@END@@@/g, '</span>');
    latexEl.innerHTML = latex.replace(/@@@HL@@@/g, '<span class="highlight">').replace(/@@@END@@@/g, '</span>');
  });
}

function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&'); }

function showCopyIndicator(button){
  const original = button.textContent;
  button.textContent = 'コピーしました ✓';
  setTimeout(()=>{ button.textContent = original; }, 1500);
}

searchInput.addEventListener('input', debounce(()=>applyFilters(), 180));
categorySelect.addEventListener('change', ()=>applyFilters());
reloadBtn.addEventListener('click', ()=>{ loadData(); });

function debounce(fn, wait){
  let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); };
}

// 初回ロード
loadData();
</script>
</body>
</html>